# User Management - Key Changes from User Request

## What Changed Based on Your Feedback

### 1. ✅ Dual Tracking for All Generations
**Your Request**: "generations should now store not only the IP, but also the user account name"

**Implementation**:
```sql
media table:
  user_id TEXT      -- ✅ Which user account generated this
  ip_address TEXT   -- ✅ From which IP address

video_jobs table:
  user_id TEXT      -- ✅ Which user account generated this
  ip_address TEXT   -- ✅ From which IP address
```

**Why Both?**
- `user_id`: Tracks ownership, quota usage, user accountability
- `ip_address`: Abuse prevention, compliance, security tracking
- **Together**: Complete accountability chain

**Example in Gallery**:
```
Generated by: alice@example.com (user account)
From IP: 192.168.1.100 (network location)
```

---

### 2. ✅ Admin-User Relationships (Many-to-Many)
**Your Request**: "users should be assigned to an admin, so that the admin can only change and edit users that they invited themself, it is possible that two admins invite the same user"

**Implementation**:
```sql
-- New table: user_admins
CREATE TABLE user_admins (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,    -- User being managed
    admin_id TEXT NOT NULL,   -- Admin who can manage them
    created_at TEXT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (admin_id) REFERENCES users(id),
    UNIQUE(user_id, admin_id)
);
```

**How It Works**:

#### Scenario 1: Single Admin
```
Admin A invites alice@example.com
→ user_admins: (alice, Admin A)
→ Admin A can manage Alice
→ Admin B cannot see Alice
```

#### Scenario 2: Multiple Admins (Shared User)
```
Admin A invites bob@example.com
→ user_admins: (bob, Admin A)

Admin B also invites bob@example.com
→ user_admins: (bob, Admin A) ← existing
                (bob, Admin B) ← new relationship

Result:
→ Both Admin A and Admin B can manage Bob
→ Bob has quotas from both admins (configurable)
→ Both admins see Bob in their user list
→ Bob's generations visible to both admins
```

#### Scenario 3: Admin Removes User
```
Admin A clicks "Remove" on Bob
→ Deletes (bob, Admin A) relationship
→ If Admin B still has (bob, Admin B):
  → Bob still exists, now only managed by Admin B
→ If no other relationships:
  → Bob is deleted (no admins manage them)
```

---

### 3. ✅ Admin-Scoped Operations

**All admin endpoints now filtered by relationship**:

#### GET /api/admin/users
```python
# Before (proposed originally):
return all_users()  # ❌ Shows all users

# Now (with your changes):
return users_invited_by(current_admin)  # ✅ Only admin's users
```

**Example**:
```
Admin A's user list:
- alice@example.com (invited by A)
- bob@example.com (invited by A, shared with B)
- charlie@example.com (invited by A)

Admin B's user list:
- bob@example.com (invited by B, shared with A)
- david@example.com (invited by B)

Note: They only see users they invited!
```

---

### 4. ✅ Gallery with User Email + IP

**Your Request**: Include user account name in generation records

**Implementation**:

#### For Regular Users (Non-Admin)
```
Gallery shows:
- Only their own generations
- IP address hidden
- Just: "Generated by you"
```

#### For Admins
```
Gallery shows:
- Generations from users they invited
- Each entry displays:
  ┌──────────────────────────────────────┐
  │ Image: "A beautiful sunset..."       │
  │ Model: Imagen 4.0                    │
  │ Generated by: alice@example.com      │ ← User email
  │ From IP: 192.168.1.100               │ ← IP address
  │ Date: Nov 11, 2025, 2:30 PM          │
  └──────────────────────────────────────┘
```

#### Filter Options for Admins
```
- Filter by user email
- Filter by IP address
- Filter by date range
- Filter by generation type
```

---

## API Examples

### Admin Creates Users with Shared User
```http
POST /api/admin/users/bulk-create
Authorization: Bearer admin-A-token

{
  "emails": [
    "alice@example.com",  // New user
    "bob@example.com"     // Already exists (invited by Admin B)
  ]
}

Response:
{
  "success": true,
  "data": {
    "created": [
      {
        "email": "alice@example.com",
        "isNew": true,
        "invitedBy": "admin-a@example.com"
      },
      {
        "email": "bob@example.com",
        "isNew": false,
        "invitedBy": "admin-a@example.com",
        "sharedWith": ["admin-b@example.com"]
      }
    ]
  }
}
```

### Admin Views User's Generations
```http
GET /api/admin/users/alice-user-id/generations
Authorization: Bearer admin-token

Response:
{
  "success": true,
  "data": {
    "user": {
      "id": "alice-user-id",
      "email": "alice@example.com"
    },
    "generations": [
      {
        "id": "media-123",
        "type": "image",
        "prompt": "A sunset over mountains",
        "userId": "alice-user-id",
        "userEmail": "alice@example.com",  // ✅ User account
        "ipAddress": "192.168.1.100",      // ✅ IP address
        "createdAt": "2025-11-11T14:30:00Z"
      },
      {
        "id": "media-124",
        "type": "video",
        "prompt": "Ocean waves",
        "userId": "alice-user-id",
        "userEmail": "alice@example.com",  // ✅ User account
        "ipAddress": "192.168.1.105",      // ✅ Different IP
        "createdAt": "2025-11-11T15:45:00Z"
      }
    ]
  }
}
```

### Admin Views Their Users Only
```http
GET /api/admin/users
Authorization: Bearer admin-A-token

Response:
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "alice-id",
        "email": "alice@example.com",
        "isActive": true,
        "isShared": false,  // Only Admin A manages Alice
        "invitedBy": "admin-a@example.com"
      },
      {
        "id": "bob-id",
        "email": "bob@example.com",
        "isActive": true,
        "isShared": true,  // ⚠️ Shared with other admins
        "invitedBy": "admin-a@example.com",
        "sharedWith": ["admin-b@example.com"]
      }
    ]
  }
}
```

---

## Database Relationships Diagram

```
┌─────────────┐
│   admins    │
│  (is_admin) │
└──────┬──────┘
       │
       │ creates/manages
       │
       ▼
┌─────────────────┐     ┌──────────────┐
│  user_admins    │────▶│    users     │
│                 │     │              │
│ user_id  ◄──────┼─────┤ id           │
│ admin_id        │     │ email        │
│                 │     │ password_hash│
└─────────────────┘     └──────┬───────┘
                               │
                               │ generates
                               │
                               ▼
                        ┌──────────────┐
                        │    media     │
                        │              │
                        │ user_id      │ ◄── Which user account
                        │ ip_address   │ ◄── From which IP
                        │ prompt       │
                        └──────────────┘
```

---

## Authorization Logic

### Can Admin Manage User?
```python
def can_admin_manage_user(admin_id: str, user_id: str) -> bool:
    """Check if admin has relationship with user."""
    relationship = db.query(UserAdmin).filter(
        UserAdmin.admin_id == admin_id,
        UserAdmin.user_id == user_id
    ).first()
    
    return relationship is not None

# Usage:
if not can_admin_manage_user(admin.id, user.id):
    raise HTTPException(403, "You don't have permission to manage this user")
```

### Who Can View Generation?
```python
def can_view_generation(viewer: User, generation: Media) -> bool:
    """Check if user can view a generation."""
    
    # Owner can always view
    if viewer.id == generation.user_id:
        return True
    
    # Admin can view if they manage the generator
    if viewer.is_admin:
        return can_admin_manage_user(viewer.id, generation.user_id)
    
    return False
```

---

## Benefits of These Changes

### 1. Complete Accountability Chain
```
Who: alice@example.com (user account)
Where: 192.168.1.100 (IP address)
What: Generated "sunset image"
When: Nov 11, 2025, 2:30 PM
```

### 2. Multi-Tenant Admin Management
- Each admin manages their own users
- Users can be shared across admins
- No admin sees another admin's exclusive users
- Collaboration enabled through shared users

### 3. Scalability
- Multiple admins can work independently
- No conflicts between admin operations
- Easy to add/remove admin relationships
- Supports organizational hierarchies

### 4. Privacy & Security
- Regular users see only their data
- Admins see only their users' data
- IP tracking for abuse prevention
- User account tracking for quota management

---

## Summary of Changes

| Feature | Original Proposal | Your Changes | Updated Design |
|---------|------------------|--------------|----------------|
| User tracking | user_id only | user_id + IP | ✅ Both stored |
| Admin access | All users | Only their users | ✅ Filtered |
| User ownership | Single admin | Multiple admins | ✅ Many-to-many |
| Gallery display | IP only (for admin) | User email + IP | ✅ Both shown |
| User creation | Create new only | Create or link | ✅ Handles both |

---

## Timeline Impact

**Original**: 14-19 hours  
**Updated**: 16-21 hours (+2 hours)

**Additional Work**:
- +1 hour: user_admins table and relationships
- +0.5 hour: Admin-scoped queries
- +0.5 hour: Gallery enhancements (email + IP display)

---

## Ready for Approval?

All your requested changes have been incorporated:
- ✅ Generations store user account + IP
- ✅ Admins only manage users they invited
- ✅ Multiple admins can invite same user
- ✅ Gallery shows user email + IP for admins

**Next**: Please review and approve to proceed with implementation!

